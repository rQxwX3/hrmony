#include "../config/include/toml.hpp"

#include <app.hpp>
#include <config.hpp>
#include <keys.hpp>
#include <macos.hpp>
#include <platform.hpp>

#include <iostream>
#include <memory>

namespace app {
#ifdef __APPLE__
App::App()
    : m_globalGroup{std::make_unique<grp::Group>(grp::createGlobalGroup())},
      m_platform{std::make_unique<mac::MacOS>(m_globalGroup.get(), this)},
      m_running{false}, m_config{conf::loadDefaultConfig()} {}
#endif

auto App::run() -> void {
    m_running = true;
    m_platform->run();
}

[[nodiscard]] auto App::isRunning() const -> bool { return m_running; }

[[nodiscard]] auto App::getConfig() const -> conf::Config { return m_config; }

[[nodiscard]] auto App::getGlobalGroup() const -> const grp::Group * {
    return m_globalGroup.get();
}

auto App::loadConfig() -> void {
    toml::table cfg;

    try {
        cfg = toml::parse_file("config.toml");
        // std::cout << tbl << '\n';
    } catch (const toml::parse_error &err) {
        std::cerr << "parsing failed:\n" << err << '\n';
        exit(1);
    }

    const auto groups{cfg["groups"].as_table()};
    const auto global{groups->get("global")->as_table()};

    for (auto &[key, value] : *global) {
        if (value.is_table()) {
            auto subgroup{value.as_table()};
            std::cout << "subgroup key is " << key << '\n';

            for (auto &[subkey, subval] : *subgroup) {
                std::cout << '\t' << subkey << '\t';

                if (subval.is_string()) {
                    std::cout << subval.as_string()->get();
                } else if (subval.is_array()) {
                    for (auto &item : *subval.as_array()) {
                        if (item.is_string()) {
                            std::cout << item.as_string()->get() << ", ";
                        }
                    }
                }

                std::cout << '\n';
            }
        }
    }
}
} // namespace app
